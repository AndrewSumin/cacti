<!DOCTYPE html>
<html>
  <head>
    <title>Состояние системы</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style>
      body{
        background:#fff;
        font-family:Tahoma, Arial;
        width:1850px;
        margin:0;
        padding-left:10px;
      }

      .graph{
        width:450px;
        height:265px;
        position:relative;
        background-position: -16px -31px;
        background-repeat:no-repeat;
      }
      .row{
        overflow:hidden;
      }
      .place{
        width:450px;
        margin-right:10px;
        float:left;
      }
      .name{
        font-size:1.2em;
        font-weight:normal;
        margin:1em 0 .3em;
        padding-left:37px;
      }
        .name__type{
          color:#999;
        }
      .legend{
        margin-top:20px;
        padding-left:40px;
      }
        .legend__item{
          margin-right:30px;
          font-weight:bold;
          text-shadow: 1px 1px 2px #000;
        }
        
      .scroller{
        position:absolute;
        left:41px;
        top:8px;
        overflow:hidden;
        width:402px;
        height:260px;
        background:white;
      }
        .scroller__list{
          white-space:nowrap;
        }
        .scroller__graph{
          width:399px;
          height:260px;
          background-position:-57px -39px;
          display:inline-block;
        }
    </style>
  </head>
  <body>
    <div class="row">
      <div class="place">
        <h1 class="name"><span class="name__type">Frontik</span> Поиск вакансий, за три часа</h1>
        <div class="graph" data="3" style="background-image:url('http://cacti.hh.ru/graph_image.php?local_graph_id=16&rra_id=5&view_type=tree&graph_start=')">
          <div class="graph__line">&#160;</div>
        </div>
      </div>
      <div class="place">
        <h1 class="name"><span class="name__type">Frontik</span> Вакансия, за три часа</h1>
        <div class="graph" data="3" style="background-image:url('http://cacti.hh.ru/graph_image.php?local_graph_id=17&rra_id=5&view_type=tree&graph_start=')">
          <div class="graph__line">&#160;</div>
        </div>
      </div>
      <div class="place">
        <h1 class="name"><span class="name__type">Frontik</span> Работодатель, за три часа</h1>
        <div class="graph" data="3" style="background-image:url('http://cacti.hh.ru/graph_image.php?local_graph_id=18&rra_id=5&view_type=tree&graph_start=')">
          <div class="graph__line">&#160;</div>
        </div>
      </div>
    </div>
    <div class="legend">
      <span class="legend__item" style="color:#DA4725">hh-session</span>
      <span class="legend__item" style="color:#EA8F00">sofea</span>
      <span class="legend__item" style="color:#FFF200">XSL</span>
      <span class="legend__item" style="color:#00BD27">fuchakubutsu</span>
    </div>
    <div class="row">
      <div class="place">
        <h1 class="name"><span class="name__type">Frontik</span> Поиск вакансий, за три часа</h1>
        <div class="graph" data="3" style="background-image:url('http://cacti.hh.ru/graph_image.php?local_graph_id=19&rra_id=5&view_type=tree&graph_start=')">
          <div class="graph__line">&#160;</div>
        </div>
      </div>
      <div class="place">
        <h1 class="name"><span class="name__type">Frontik</span> Вакансия, за три часа</h1>
        <div class="graph" data="3" style="background-image:url('http://cacti.hh.ru/graph_image.php?local_graph_id=20&rra_id=5&view_type=tree&graph_start=')">
          <div class="graph__line">&#160;</div>
        </div>
      </div>
      <div class="place">
        <h1 class="name"><span class="name__type">Frontik</span> Работодатель, за три часа</h1>
        <div class="graph" data="3" style="background-image:url('http://cacti.hh.ru/graph_image.php?local_graph_id=21&rra_id=5&view_type=tree&graph_start=')">
          <div class="graph__line">&#160;</div>
        </div>
      </div>
    </div>
    <div class="legend">
      <span class="legend__item" style="color:#DA4725">больше 2 секунд</span>
      <span class="legend__item" style="color:#FFF200">больше 0.5 секунды</span>
      <span class="legend__item" style="color:#00BD27">все хорошо</span>
    </div>
    <div class="row">
      <div class="place">
        <h1 class="name"><span class="name__type">XSL</span> Поиск вакансий, за три часа</h1>
        <div class="graph" data="3" style="background-image:url('http://cacti.hh.ru/graph_image.php?local_graph_id=22&rra_id=5&view_type=tree&graph_start=')">
          &#160;
        </div>
      </div>
      <div class="place">
        <h1 class="name"><span class="name__type">XSL</span> Вакансия, за три часа</h1>
        <div class="graph" data="3" style="background-image:url('http://cacti.hh.ru/graph_image.php?local_graph_id=23&rra_id=5&view_type=tree&graph_start=')">
          &#160;
        </div>
      </div>
      <div class="place">
        <h1 class="name"><span class="name__type">XSL</span> Работодатель, за три часа</h1>
        <div class="graph" data="3" style="background-image:url('http://cacti.hh.ru/graph_image.php?local_graph_id=24&rra_id=5&view_type=tree&graph_start=')">
          &#160;
        </div>
      </div>
    </div>
    <div class="legend">
      <span class="legend__item" style="color:#FFBB99">99-я квантиль</span>
      <span class="legend__item" style="color:#FF742E">95-я квантиль</span>
      <span class="legend__item" style="color:#FF5600">90-я квантиль</span>
    </div>
    <form id="login" style="display:none;" action="http://cacti.hh.ru/graph.php" method="post" target="login">
      <input type="hidden" name="action" value="login"/>
      <input type="hidden" name="login_username" value="guest"/>
      <input type="hidden" name="login_password" value="guest"/>
    </form>
    <iframe name="login" style="display:none;">&#160;</iframe>
    <script>
      (function(){
        var graphs = document.querySelectorAll(".graph");
        for (var i = 0; i < graphs.length; i++){
          reload(graphs[i]);
          doScroll(graphs[i]);
        }

        function reload(graph){
          graph.img = graph.img || (function(){
            var img = document.createElement('img');
            img.onload = update(graph);
            img.onerror = error(graph);
            return img;
          })();
          graph.img.src = getGraphUrl(graph);
        }
        
        function getGraphData(graph){
          var bgUrl = graph.style.backgroundImage;
          var hours = graph.hours || (graph.hours = parseInt(graph.getAttribute('data'), 10));
          var start = bgUrl.match(/graph_start=(\d*)/)[1] || Math.round((new Date().getTime() - 1000 * 60 * 60 * hours) / 1000);
          var end = Math.round(parseInt(start, 10) + 60 * 60 * hours);
          var url = getGraphUrl(graph, {start:start, end:end});
          return {
            start: start,
            end: end,
            url: url,
            hours: hours
          };
        }
        
        function getGraphUrl(graph, data){
          data = data || {};
          var bgUrl = graph.style.backgroundImage;
          var url = bgUrl.match(/url\("(.*)"\)/) ? bgUrl.match(/url\("(.*)"\)/)[1] : bgUrl.match(/url\((.*)\)/)[1];
          var hours = graph.hours || (graph.hours = parseInt(graph.getAttribute('data'), 10));
          var start = data.start || Math.round((new Date().getTime() - 1000 * 60 * 60 * graph.hours) / 1000);
          var end = data.end || Math.round(parseInt(start, 10) + 60 * 60 * graph.hours);
          return url.replace(/&graph_start=\d*/, '').replace(/&graph_end=\d*/, '') + '&graph_start=' + start + '&graph_end=' + end;
        }
        
        function getGraphDataBefore(graph){
          var data = getGraphData(graph);
          data.end = parseInt(data.start, 10) - 1;
          data.start = Math.round((new Date(data.end * 1000).getTime() - 1000 * 60 * 60 * data.hours) / 1000);
          data.url = data.url.replace(/&graph_start=\d*/, '').replace(/&graph_end=\d*/, '') + '&graph_start=' + data.start + '&graph_end=' + data.end;
          return data;
        }
        
        function getGraphDataAfter(graph){
          var data = getGraphData(graph);
          data.start = parseInt(data.end, 10) + 1;
          data.end = Math.round((new Date(data.start * 1000).getTime() + 1000 * 60 * 60 * data.hours) / 1000);
          data.url = data.url.replace(/&graph_start=\d*/, '').replace(/&graph_end=\d*/, '') + '&graph_start=' + data.start + '&graph_end=' + data.end;
          return data;
        }
       
        function update(graph){
          return function(){
            graph.style.backgroundImage = 'url("' + graph.img.src + '")';
            graph.style.opacity = 1;
            window.setTimeout(function(){
              reload(graph);
            }, 30000);
          };
        }

        
        function error(graph){
          return function(graph){
            window.setTimeout(function(){
              reload(graph);
            }, 10000);
          };
        }
        
        function doScroll(graph){
          function wheel(event){
            event.preventDefault();
            if (event.ctrlKey) {
              changeStep(graph, -event.detail);
            } else {
              var delta = (event.axis == event.HORIZONTAL_AXIS ? 1 : -1) * event.detail * 5;
              if (graph.hours != 3) {
                moveScroll(graph, delta);
              } else {
                moveScrolls(delta);
              }
            }
          }
          
          var scroller = document.createElement('div');
          scroller.className = 'scroller';
          scroller.scrollerList = scroller.appendChild(document.createElement('div'));
          scroller.scrollerList.className = 'scroller__list';
          
          graph.scroller = scroller;
          graph.addEventListener('DOMMouseScroll', wheel, false);
        }
        
        function moveScrolls(delta){
          for (var i = 0; i < graphs.length; i++) {
            moveScroll(graphs[i], delta);
          }
        }
        
        function moveScroll(graph, delta){
          var scroller = graph.scroller;
          placeScroller(graph);
          scroller.scrollLeft += delta;
          
          if (scroller.scrollLeft < scroller.offsetWidth * 2 && delta < 0){
            updateScroller(scroller, getGraphDataBefore(scroller.scrollerList.querySelector('.scroller__graph')), 'before');
          }
          
          if (scroller.scrollLeft + scroller.offsetWidth * 3 > scroller.scrollWidth && delta > 0){
            var scrolls = scroller.scrollerList.querySelectorAll('.scroller__graph');
            updateScroller(scroller, getGraphDataAfter(scrolls[scrolls.length - 1]), 'after');
          }
        }
        
        function placeScroller(graph){
          if (graph.querySelector('.scroller')){
            return;
          }
          var scroller = graph.scroller;
          if (scroller.timer){
            window.clearTimeout(scroller.timer);
          }
          clearScroller(graph);
          graph.appendChild(scroller);
          updateScroller(scroller, getGraphData(graph));
          updateScroller(scroller, getGraphDataBefore(scroller.scrollerList.querySelector('.scroller__graph')), 'before');
          updateScroller(scroller, getGraphDataBefore(scroller.scrollerList.querySelector('.scroller__graph')), 'before');
          var after = scroller.scrollerList.querySelectorAll('.scroller__graph');
          updateScroller(scroller, getGraphDataAfter(after[after.length - 1]), 'after');
          after = scroller.scrollerList.querySelectorAll('.scroller__graph');
          updateScroller(scroller, getGraphDataAfter(after[after.length - 1]), 'after');
          scroller.scrollLeft = after[after.length - 1].offsetWidth * 2;
          scroller.timer = window.setTimeout(function(){
            clearScroller(graph);
          }, 1000 * 60 * 3); // 3 минуты
        }
        
        function reloadScroller(graph, scale){
          var scroller = graph.scroller;
          var hours = graph.hours / scale;
          scroller.scrollLeft = graph.defScroll;
          var width = scroller.scrollerList.querySelectorAll('.scroller__graph')[0].offsetWidth * 5;
          var totalbefore = graph.hours * 5 * 60 * 60;
          var totalafter = hours * 5 * 60 * 60;
          
          var shiftbefore = totalbefore * scroller.scrollLeft / width;
          var shiftafter = totalafter * scroller.scrollLeft / width;
          
          var visiblestart = parseInt(getGraphData(scroller.scrollerList.querySelectorAll('.scroller__graph')[0]).start, 10) + shiftbefore;
          var start = visiblestart - shiftafter;
          
          
          graph = scroller.scrollerList.querySelectorAll('.scroller__graph')[0];
          graph.hours = hours;
          graph.start = start;
          graph.style.backgroundImage = 'url("' + getGraphUrl(graph, {start:start})  + '")';
          scroller.scrollerList.querySelectorAll('.scroller__graph')[1]
            .style.backgroundImage = 'url("' + getGraphDataAfter(graph).url  + '")';
            
          graph = scroller.scrollerList.querySelectorAll('.scroller__graph')[1];
          graph.hours = hours;
          scroller.scrollerList.querySelectorAll('.scroller__graph')[2]
            .style.backgroundImage = 'url("' + getGraphDataAfter(graph).url  + '")';
          
          graph = scroller.scrollerList.querySelectorAll('.scroller__graph')[2];
          graph.hours = hours;
          scroller.scrollerList.querySelectorAll('.scroller__graph')[3]
            .style.backgroundImage = 'url("' + getGraphDataAfter(graph).url  + '")';
            
          graph = scroller.scrollerList.querySelectorAll('.scroller__graph')[3];
          graph.hours = hours;
          scroller.scrollerList.querySelectorAll('.scroller__graph')[4]
            .style.backgroundImage = 'url("' + getGraphDataAfter(graph).url  + '")';
            
          //scroller.scrollLeft = scroller.scrollerList.querySelectorAll('.scroller__graph')[0].offsetWidth * 2;
        }
        
        function updateScroller(scroller, data, direction){
          var scroll = document.createElement('div');
          scroll.className = 'scroller__graph';
          scroll.style.backgroundImage = 'url("' + data.url  + '")';
          scroll.hours = data.hours;
          switch (direction){
            case 'before':
              updateScrollerBefore(scroller, scroll);
              break;
            case 'after':
              updateScrollerAfter(scroller, scroll);
              break;
            default:
              scroller.scrollerList.appendChild(scroll);
          }
        }
        
        function updateScrollerBefore(scroller, scroll){
          var firstChild = scroller.scrollerList.querySelector('.scroller__graph');
          var scrolls = scroller.scrollerList.querySelectorAll('.scroller__graph');
          scroller.scrollerList.insertBefore(scroll, firstChild);
          if (scrolls.length > 4) {
            scroller.scrollerList.removeChild(scrolls[scrolls.length - 1]);
          }
          scroller.scrollLeft += scroll.offsetWidth;
        }
        
        function updateScrollerAfter(scroller, scroll){
          var scrolls = scroller.scrollerList.querySelectorAll('.scroller__graph');
          scroller.scrollerList.appendChild(scroll);
          if (scrolls.length > 4){
            var firstChild = scroller.scrollerList.querySelector('.scroller__graph');
            scroller.scrollerList.removeChild(firstChild);
            scroller.scrollLeft -= scroll.offsetWidth;
          }
        }
        
        document.body.onclick = clearScrollers;
                
        function clearScrollers(){
          for (var i = 0; i < graphs.length; i++) {
            clearScroller(graphs[i]);
            graphs[i].hours = 3;
            reload(graphs[i]);
          }
        }
        
        function clearScroller(graph){
          var scroller = graph.scroller;
          scroller.scrollerList.innerHTML = '';
          if (scroller.parentNode){
            scroller.parentNode.removeChild(scroller);
          }
        }
        
        function changeSteps(delta){
          for (var i = 0; i < graphs.length; i++) {
            changeStep(graphs[i], delta);
          }
        }
        
        function changeStep(graph, delta){
          placeScroller(graph);
          if (graph.scaletimer){
            window.clearTimeout(graph.scaletimer);
          }
          var scroller = graph.scroller;
          var scale = scroller.scrollerList.style.MozTransform ? parseFloat(scroller.scrollerList.style.MozTransform.match(/scale\((\d+\.?\d?).*\)/)[1]) : 1;
          if (scale == 1){
            graph.defScroll = scroller.scrollLeft;
          }
          scale = scale + delta / 10;
          scale = scale > 0 ? scale : 0.1;
          scale = scale < 5 ? scale : 5;
          scroller.scrollerList.style.MozTransform = 'scale('+ scale +', 1)';
          scroller.scrollLeft = graph.defScroll * scale;
          graph.scaletimer = window.setTimeout(function(){
            scroller.scrollerList.style.MozTransform = 'scale(1, 1)';
            updateHours(graph, scale);
          }, 1000);
        }
        
        function updateHours(graph, scale){
          reloadScroller(graph, scale);
          graph.hours = graph.hours / scale;
          //reload(graph);
        }
      })();
      
    </script>
  </body>
</html>
